language: c

git:
  depth: 3

addons:
  apt:
    sources:
    - sourceline: 'deb https://apt.kitware.com/ubuntu/ ${TRAVIS_DIST} main'
      key_url: 'https://apt.kitware.com/keys/kitware-archive-latest.asc'
    update: true
    packages:
    - cmake
    - libsndfile1-dev
    - libfftw3-dev
    - libboost-dev
    - doxygen
    - graphviz
# This fails "/usr/local/bin/brew tap homebrew/bundle": Error: Unknown command: bundle
#   homebrew:
#     update: false
#     packages:
#     - ccache
#     - cmake
#     - libsndfile
#     - fftw
#     - boost
#     - doxygen
#     - graphviz

cache:
  ccache: true

before_install:
- export PATH="${PATH}:${PWD}/deps/build-scripts/bin"
- uname -a
- set -e -o pipefail

install:
- source ci/install-deps.${TRAVIS_OS_NAME}.sh
- source ci/build-deps.sh
- cmake --version

script:
- mkdir -p build && pushd build
- cmake ${TARGET_PLATFORM:+-A ${TARGET_PLATFORM}} "-DCMAKE_PREFIX_PATH=${PWD}/deps/install" ..
- cmake --build . --config RelWithDebInfo -- -j3
- ctest --output-on-failure -C RelWithDebInfo -T test -j3
- cmake --build . --config RelWithDebInfo --target docs -- -j3
- cmake --build . --config RelWithDebInfo --target package -- -j3

matrix:
  include:
  - os: osx
    name: macOS 10.14 (10.15 SDK)
    osx_image: xcode11.2
  - os: osx
    name: macOS 10.13 (10.14 SDK)
    osx_image: xcode10.1
  - os: osx
    name: macOS 10.12 (10.13 SDK)
    osx_image: xcode9.2
  - os: linux
    name: Bionic-x64
    dist: bionic
  - os: linux
    name: Xenial-x64
    dist: xenial
# TODO: investigate why this fails on travis
#   - os: linux
#     name: Bionic-ARM64
#     dist: bionic
#     arch: arm64
#   - os: linux
#     name: Xenial-ARM64
#     dist: xenial
#     arch: arm64
  - os: windows
    name: Win32
    env: TARGET_PLATFORM=Win32
  - os: windows
    name: Win64
    env: TARGET_PLATFORM=x64
